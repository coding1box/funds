# 发票与回款流程说明文档

## 概述

本文档详细说明了系统中的发票与回款业务流程，包括各角色的职责和操作步骤。

---

## 一、普通开票流程

### 流程图
```
客户经理申请 → 部门领导审批 → 财务审批 → 财务上传发票 → 客户经理确认 → 办结 → 回款流程
```

### 详细步骤

#### 1. 客户经理申请开票
- **角色**：客户经理
- **操作**：在"发票管理"页面创建新发票申请
- **填写内容**：
  - 基本信息：申请人、申请类型、合同编码、合同名称等
  - 发票信息：发票类型、服务设备类型、税率、金额等
- **状态变化**：`draft` → `pending_dept_leader_approval`

#### 2. 部门领导审批
- **角色**：部门领导
- **操作**：在"我的待办"页面审批发票申请
- **审批选项**：
  - 通过：转财务部审核
  - 驳回：返回客户经理修改
- **状态变化**：
  - 通过：`pending_dept_leader_approval` → `pending_finance_approval`
  - 驳回：`pending_dept_leader_approval` → `rejected`

#### 3. 财务审批
- **角色**：财务人员
- **操作**：在"我的待办"页面审批发票申请
- **审批选项**：
  - 通过：待财务上传发票信息
  - 驳回：返回客户经理修改
- **状态变化**：
  - 通过：`pending_finance_approval` → `approved`
  - 驳回：`pending_finance_approval` → `rejected`

#### 4. 财务上传发票
- **角色**：财务人员
- **操作**：在"发票管理"页面上传已开具的发票信息
- **填写内容**：
  - 已开发票号码
  - 开票日期
  - 发票文件
  - 备注
- **状态变化**：`approved` → `pending_customer_confirmation`
- **系统动作**：自动生成待办给客户经理

#### 5. 客户经理确认发票
- **角色**：客户经理
- **操作**：在"我的待办"页面确认发票信息
- **确认内容**：核对发票号、金额等信息是否正确
- **状态变化**：`pending_customer_confirmation` → `settled`

#### 6. 办结
- **说明**：发票流程办结，等待回款
- **状态**：`settled`

---

## 二、集团开票流程

### 流程图
```
客户经理申请集团开票 → 部门领导审核集团开票 → 商务支撑上传集团发票 → 客户经理确认 → 办结 → 回款流程
```

### 详细步骤

#### 1. 客户经理申请集团开票
- **角色**：客户经理
- **操作**：在"发票管理"页面创建集团开票申请
- **特殊标记**：申请中注明"集团统一开票"
- **状态变化**：`draft` → `group_billing_pending`

#### 2. 部门领导审核集团开票
- **角色**：部门领导
- **操作**：在"我的待办"页面审核集团开票申请
- **审批选项**：
  - 通过：商务支撑中心处理
  - 驳回：返回客户经理修改
- **状态变化**：
  - 通过：`group_billing_pending` → `group_billing_reviewed`
  - 驳回：`group_billing_pending` → `rejected`

#### 3. 商务支撑上传集团发票
- **角色**：商务支撑人员
- **操作**：在"发票管理"页面上传集团开具的发票信息
- **填写内容**：
  - 集团发票号码（前缀：GROUP-）
  - 开票日期
  - 发票文件
  - 备注
- **状态变化**：`group_billing_reviewed` → `pending_customer_confirmation`
- **系统动作**：自动生成待办给客户经理

#### 4. 客户经理确认集团发票
- **角色**：客户经理
- **操作**：在"我的待办"页面确认集团发票信息
- **状态变化**：`pending_customer_confirmation` → `settled`

---

## 三、回款流程

### 流程图
```
商务支撑登记回款 → 财务确认回款 → 对账完成
```

### 详细步骤

#### 1. 商务支撑登记回款
- **角色**：商务支撑人员
- **操作**：在"回款管理"页面登记回款信息
- **前提条件**：
  - 在集团资金系统查到流水
  - 确认到账后启动内部付款流程
- **填写内容**：
  - 关联发票
  - 回款金额
  - 回款日期
  - 银行流水号
  - 备注
- **状态变化**：`pending`

#### 2. 财务确认回款
- **角色**：财务人员
- **操作**：在"我的待办"页面确认回款
- **确认内容**：核对回款金额、银行流水等信息
- **系统动作**：自动关联回款与发票
- **状态变化**：`pending` → `confirmed`

#### 3. 对账完成
- **角色**：财务人员
- **操作**：在"回款管理"页面完成对账
- **状态变化**：`confirmed` → `reconciled`
- **流程结束**：整个发票与回款流程完成

---

## 四、角色职责说明

### 客户经理（张、李）
- 创建发票申请
- 处理被驳回的发票
- 确认财务/商务支撑上传的发票

### 部门领导（刘）
- 审批普通开票申请
- 审核集团开票申请

### 财务人员（王）
- 审批发票申请
- 上传已开具的普通发票
- 确认回款
- 完成对账

### 商务支撑人员（赵）
- 上传集团开具的发票
- 登记回款信息

---

## 五、发票状态说明

| 状态 | 说明 | 前置状态 | 后置状态 |
|-----|------|---------|---------|
| draft | 草稿 | - | pending_dept_leader_approval / group_billing_pending |
| pending_dept_leader_approval | 待部门领导审批 | draft | pending_finance_approval / rejected |
| pending_finance_approval | 待财务审批 | pending_dept_leader_approval | approved / rejected |
| approved | 已审批（待上传） | pending_finance_approval | pending_customer_confirmation |
| rejected | 已拒绝 | pending_dept_leader_approval / pending_finance_approval / group_billing_pending | - |
| pending_customer_confirmation | 待客户确认 | approved / group_billing_reviewed | settled |
| settled | 已办结 | pending_customer_confirmation | - |
| group_billing_pending | 集团开票待审核 | draft | group_billing_reviewed / rejected |
| group_billing_reviewed | 集团开票已审核 | group_billing_pending | pending_customer_confirmation |

---

## 六、回款状态说明

| 状态 | 说明 | 前置状态 | 后置状态 |
|-----|------|---------|---------|
| pending | 待确认（商务支撑已登记） | - | confirmed |
| confirmed | 已确认（财务已确认） | pending | reconciled |
| reconciled | 已对账 | confirmed | - |

---

## 七、模拟数据说明

### 发票数据（7条）

1. **INV-2024-001**（普通开票）
   - 状态：`pending_dept_leader_approval`
   - 项目：项目A
   - 金额：500,000元
   - 流程节点：待部门领导审批

2. **INV-2024-002**（普通开票）
   - 状态：`pending_finance_approval`
   - 项目：项目B
   - 金额：300,000元
   - 流程节点：待财务审批

3. **INV-2024-003**（普通开票）
   - 状态：`approved`
   - 项目：项目C
   - 金额：800,000元
   - 流程节点：待财务上传发票

4. **INV-2024-004**（普通开票）
   - 状态：`pending_customer_confirmation`
   - 项目：项目A
   - 金额：600,000元
   - 流程节点：待客户经理确认

5. **INV-2024-005**（普通开票）
   - 状态：`settled`
   - 项目：项目B
   - 金额：400,000元
   - 流程节点：已办结，等待回款

6. **INV-2024-006**（集团开票）
   - 状态：`group_billing_pending`
   - 项目：项目C
   - 金额：1,200,000元
   - 流程节点：待部门领导审核集团开票

7. **INV-2024-007**（集团开票）
   - 状态：`pending_customer_confirmation`
   - 项目：项目A
   - 金额：900,000元
   - 流程节点：待客户经理确认（商务支撑已上传集团发票）

### 回款数据（3条）

1. **TXN202403100001**（待确认）
   - 关联发票：INV-2024-002
   - 金额：300,000元
   - 状态：`pending`
   - 说明：商务支撑登记，待财务确认

2. **TXN202403150001**（已确认）
   - 关联发票：INV-2024-005
   - 金额：400,000元
   - 状态：`confirmed`
   - 说明：财务已确认，待对账

3. **TXN202403130001**（已对账）
   - 关联发票：INV-2024-004
   - 金额：600,000元
   - 状态：`reconciled`
   - 说明：已完成对账

---

## 八、测试流程建议

### 测试1：普通开票完整流程
1. 切换到"张经理"角色
2. 在"发票管理"页面创建新发票申请
3. 切换到"刘领导"角色，在"我的待办"页面审批通过
4. 切换到"王财务"角色，在"我的待办"页面审批通过
5. 切换到"王财务"角色，在"发票管理"页面上传发票
6. 切换到"张经理"角色，在"我的待办"页面确认发票

### 测试2：集团开票完整流程
1. 切换到"李经理"角色
2. 在"发票管理"页面创建集团开票申请（备注：集团统一开票）
3. 切换到"刘领导"角色，在"我的待办"页面审核通过
4. 切换到"赵商务"角色，在"发票管理"页面上传集团发票
5. 切换到"李经理"角色，在"我的待办"页面确认发票

### 测试3：回款流程
1. 切换到"赵商务"角色
2. 在"回款管理"页面登记回款
3. 切换到"王财务"角色，在"我的待办"页面确认回款
4. 切换到"王财务"角色，在"回款管理"页面完成对账

---

## 九、注意事项

1. **角色切换**：使用页面右上角的角色切换器切换不同角色进行操作
2. **数据持久化**：所有操作数据保存在浏览器 localStorage 中
3. **待办刷新**：操作完成后，待办列表会自动刷新
4. **流程闭环**：确保每个流程节点都有相应的待办提醒
5. **状态追踪**：通过发票列表的状态标签了解当前流程节点

---

## 十、常见问题

### Q1：如何查看某个角色的待办？
A：切换到对应角色后，访问"我的待办"页面即可查看所有待办事项。

### Q2：发票被驳回后如何处理？
A：客户经理可以在"发票管理"页面查看被驳回的发票，修改后重新提交。

### Q3：集团开票和普通开票有什么区别？
A：
- 普通开票：财务上传发票后，客户经理确认
- 集团开票：部门领导审核后，商务支撑上传集团发票，然后客户经理确认

### Q4：回款如何关联发票？
A：在登记回款时选择对应的发票，系统会自动建立关联。

### Q5：如何重置测试数据？
A：在浏览器控制台执行 `localStorage.clear()`，然后刷新页面即可恢复默认数据。

---

## 十一、技术实现说明

### 前端技术栈
- React + TypeScript
- Next.js
- shadcn/ui 组件库

### 数据存储
- 使用 localStorage 进行本地数据持久化
- 模拟后端 API 接口

### 核心功能
1. 角色权限控制
2. 流程状态管理
3. 待办事项自动生成
4. 数据关联与查询

---

## 总结

本系统实现了完整的发票与回款业务流程，包括：
- ✅ 普通开票流程（客户经理→部门领导→财务→上传→确认）
- ✅ 集团开票流程（客户经理→部门领导→商务支撑→确认）
- ✅ 回款流程（商务支撑登记→财务确认→对账）
- ✅ 角色权限管理
- ✅ 待办事项自动推送
- ✅ 流程状态追踪

系统已按照业务流程要求配置了完整的模拟数据，可以进行端到端的流程测试。
